name: Python CI/CD Cloud Run Deployment

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
# ------------- Lint & tests -------------
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - uses: pre-commit/action@v3.0.1
        with: { extra_args: --all-files }

  pytest:
    runs-on: ubuntu-latest
    needs: pre-commit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest
      - name: Run tests
        run: |
          pytest tests/
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up gcloud
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: sentivista-453008
        install_components: 'gcloud beta'

    - name: Docker auth for Artifact Registry
      run: |
        gcloud auth configure-docker europe-west1-docker.pkg.dev

    - name: Build Docker image
      run: |
        docker build -t europe-west1-docker.pkg.dev/sentivista-453008/Sentivista-automatic-deployment/app .

    - name: Push Docker image
      run: |
        docker push europe-west1-docker.pkg.dev/sentivista-453008/Sentivista-automatic-deployment/app

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy app \
          --image europe-west1-docker.pkg.dev/sentivista-453008/Sentivista-automatic-deployment/app \
          --region europe-west1 \
          --platform managed \
          --allow-unauthenticated